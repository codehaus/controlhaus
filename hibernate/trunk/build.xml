<?xml version="1.0" ?>

<project name="controls-blank" default="usage">

	<property environment="os"/>
	<property file="${os.BEEHIVE_HOME}/beehive.properties"/>

	<property name="source.dir" value="${basedir}/src/main"/>
	<property name="tests.dir" value="${basedir}/src/test"/>
	<property name="build.dir" value="${basedir}/build"/>
	<property name="build.jar" value="hibernate-control-1.0-alpha-1-SNAPSHOT.jar"/>
	<property name="build.classes" value="${build.dir}/classes"/>
	<property name="build.tests" value="${build.dir}/test-classes"/>
	<property name="build.beansrc" value="${build.dir}/beansrc"/>
	<property name="build.beantest" value="${build.dir}/beantest"/>
	<property name="report.tests" value="${build.dir}/reports"/>

	<target name="usage">
		<echo message=""/>
		<echo message=""/>
		<echo message="Controls Template Build file"/>
		<echo message="================================================================"/>
		<echo message="|                          Usage                               |"/>
		<echo message="================================================================"/>
		<echo message="----------------------------------------------------------------"/>
		<echo message="|                      Standard Targets                        |"/>
		<echo message="----------------------------------------------------------------"/>
		<echo message="clean               - Delete all generated files"/>
		<echo message="build               - build controls"/>
		<echo message="test                - test controls"/>
		<echo message="----------------------------------------------------------------"/>
	</target>

	<target name="clean" description="Deletes all generated files">
		<delete dir="${build.dir}"/>
		<delete file="velocity.log"/>
	</target>

	<target name="dirs">
		<mkdir dir="${build.classes}" />
		<mkdir dir="${build.tests}" />
		<mkdir dir="${report.tests}" />
		<mkdir dir="${build.beansrc}" />
		<mkdir dir="${basedir}/lib" />
	</target>

	<target name="gatherDeps" description="Gathers Dependencies">
		<get src="http://www.ibiblio.org/maven/dom4j/jars/dom4j-1.4.jar"
		      dest="${basedir}/lib/dom4j-1.4.jar"
		      usetimestamp="true"/>
		<get src="http://www.ibiblio.org/maven/log4j/jars/log4j-1.2.8.jar"
		      dest="${basedir}/lib/log4j-1.2.8.jar"
		      usetimestamp="true"/>
		<get src="http://www.ibiblio.org/maven/velocity/jars/velocity-1.4.jar"
		      dest="${basedir}/lib/velocity-1.4.jar"
		      usetimestamp="true"/>
		<get src="http://www.ibiblio.org/maven/hibernate/jars/hibernate-2.1.6.jar"
		      dest="${basedir}/lib/hibernate-2.1.6.jar"
		      usetimestamp="true"/>

		<!-- Dependencies for testing -->
		<get src="http://www.ibiblio.org/maven/commons-logging/jars/commons-logging-1.0.3.jar"
		      dest="${basedir}/lib/commons-logging-1.0.3.jar"
		      usetimestamp="true"/>
		<get src="http://www.ibiblio.org/maven/commons-beanutils/jars/commons-beanutils-1.6.jar"
		      dest="${basedir}/lib/commons-beanutils-1.6.jar"
		      usetimestamp="true"/>
		<get src="http://www.ibiblio.org/maven/commons-collections/jars/commons-collections-3.0.jar"
		      dest="${basedir}/lib/commons-collections-3.0.jar"
		      usetimestamp="true"/>
		<get src="http://www.ibiblio.org/maven/cglib/jars/cglib-full-2.0.1.jar"
		      dest="${basedir}/lib/cglib-full-2.0.1.jar"
		      usetimestamp="true"/>
		<get src="http://www.ibiblio.org/maven/ehcache/jars/ehcache-0.7.jar"
		      dest="${basedir}/lib/ehcache-0.7.jar"
		      usetimestamp="true"/>
		<get src="http://www.ibiblio.org/maven/hsqldb/jars/hsqldb-1.7.2.2.jar"
		      dest="${basedir}/lib/hsqldb-1.7.2.2.jar"
		      usetimestamp="true"/>
		<get src="http://www.ibiblio.org/maven/geronimo-spec/jars/geronimo-spec-jta-DEV.jar"
		      dest="${basedir}/lib/geronimo-spec-jta-DEV.jar"
		      usetimestamp="true"/>
		
		<path id="build.classpath">
			<fileset dir="lib">
				<include name="**/*.jar" />
			</fileset>
			<pathelement path="${build.classes}" />
		</path>

		<taskdef name="apt" 
			     classname="org.apache.beehive.controls.runtime.generator.AptTask" 
			     onerror="report"
		         classpathref="build.classpath"/>

		<taskdef name="control-jar" 
	             classname="org.apache.beehive.controls.runtime.packaging.ControlJarTask" 
	    	     onerror="report" 
			     classpathref="build.classpath"/>
	</target>

	<target name="build" depends="dirs,gatherDeps" description="Builds controls sources">
		<apt srcdir="${source.dir}" destdir="${build.classes}" gendir="${build.beansrc}"
             classpathref="build.classpath"
             debug="on"
             compileByExtension="true"
             srcExtensions="*.java,*.jcx,*.jcs"
        	 target="1.5">
		</apt>
		<control-jar destfile="${build.dir}/${build.jar}"  basedir="${build.classes}" />
	</target>

	<target name="test" depends="build" description="Runs tests">

		<path id="test.classpath">
			<fileset dir="lib">
				<include name="**/*.jar"/>
			</fileset>
			<pathelement path="${build.classes}"/>
			<pathelement location="${build.dir}/${build.jar}"/>
			<pathelement location="${build.tests}"/>
		</path>

		<apt srcdir="${tests.dir}" destdir="${build.tests}" gendir="${build.beantest}"
             classpathref="test.classpath"
             debug="on"
             compileByExtension="true"
             srcExtensions="*.java,*.jcx,*.jcs"
        	 target="1.5">
		</apt>

		<copy todir="${build.tests}">
			<fileset dir="${tests.dir}">
				<include name="**/*.xml"/>
			</fileset>
		</copy>

		<junit printsummary="yes" haltonfailure="yes">

			<classpath refid="test.classpath"/>

			<formatter type="plain"/>

			<batchtest fork="yes" todir="${report.tests}">
				<fileset dir="${tests.dir}">
					<include name="**/*Test*.java"/>
					<exclude name="**/AllTests.java"/>
					<exclude name="**/Abstract*.java"/>
				</fileset>
			</batchtest>
		</junit>
	</target>

</project>
